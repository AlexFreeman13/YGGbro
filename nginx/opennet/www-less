# OpenNet Mirror
#
# https://opennet.ru
# https://opennet.me
#
# Configuration disable all JS by default, main menu requires exception @TODO
# https://github.com/YGGverse/issues/1

server {

  # HTTP/IPv6 connections only
  # listen [::]:80 ipv6only=on;

  # Yggdrasil connections only
  # allow 0200::/7;
  # deny all;

  # Tell to server, that's proxy request
  # proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  # proxy_set_header X-Real-IP $remote_addr;

  location /opennet {

    proxy_pass https://opennet.ru/;

    # .
    sub_filter 'http://opennet.ru' 'http://[$server_addr]/opennet';
    sub_filter 'https://opennet.ru' 'http://[$server_addr]/opennet';

    sub_filter 'http://opennet.me' 'http://[$server_addr]/opennet';
    sub_filter 'https://opennet.me' 'http://[$server_addr]/opennet';

    # www
    # sub_filter 'http://www.opennet.ru' 'http://[$server_addr]/opennet/www';
    # sub_filter 'https://www.opennet.ru' 'http://[$server_addr]/opennet/www';

    # sub_filter 'http://www.opennet.me' 'http://[$server_addr]/opennet/www';
    # sub_filter 'https://www.opennet.me' 'http://[$server_addr]/opennet/www';

    # m
    # sub_filter 'http://m.opennet.ru' 'http://[$server_addr]/opennet/m';
    # sub_filter 'https://m.opennet.ru' 'http://[$server_addr]/opennet/m';

    # sub_filter 'http://m.opennet.me' 'http://[$server_addr]/opennet/m';
    # sub_filter 'https://m.opennet.me' 'http://[$server_addr]/opennet/m';

    # mobile
    # sub_filter 'http://mobile.opennet.ru' 'http://[$server_addr]/opennet/mobile';
    # sub_filter 'https://mobile.opennet.ru' 'http://[$server_addr]/opennet/mobile';

    # sub_filter 'http://mobile.opennet.me' 'http://[$server_addr]/opennet/mobile';
    # sub_filter 'https://mobile.opennet.me' 'http://[$server_addr]/opennet/mobile';

    # wiki
    # sub_filter 'http://wiki.opennet.ru' 'http://[$server_addr]/opennet/wiki';
    # sub_filter 'https://wiki.opennet.ru' 'http://[$server_addr]/opennet/wiki';

    # sub_filter 'http://wiki.opennet.me' 'http://[$server_addr]/opennet/wiki';
    # sub_filter 'https://wiki.opennet.me' 'http://[$server_addr]/opennet/wiki';

    # solaris
    # sub_filter 'http://solaris.opennet.ru' 'http://[$server_addr]/opennet/solaris';
    # sub_filter 'https://solaris.opennet.ru' 'http://[$server_addr]/opennet/solaris';

    # sub_filter 'http://solaris.opennet.me' 'http://[$server_addr]/opennet/solaris';
    # sub_filter 'https://solaris.opennet.me' 'http://[$server_addr]/opennet/solaris';

    # bsd
    # sub_filter 'http://bsd.opennet.ru' 'http://[$server_addr]/opennet/bsd';
    # sub_filter 'https://bsd.opennet.ru' 'http://[$server_addr]/opennet/bsd';

    # sub_filter 'http://bsd.opennet.me' 'http://[$server_addr]/opennet/bsd';
    # sub_filter 'https://bsd.opennet.me' 'http://[$server_addr]/opennet/bsd';

    # cisco
    # sub_filter 'http://cisco.opennet.ru' 'http://[$server_addr]/opennet/cisco';
    # sub_filter 'https://cisco.opennet.ru' 'http://[$server_addr]/opennet/cisco';

    # sub_filter 'http://cisco.opennet.me' 'http://[$server_addr]/opennet/cisco';
    # sub_filter 'https://cisco.opennet.me' 'http://[$server_addr]/opennet/cisco';

    # linux
    # sub_filter 'http://linux.opennet.ru' 'http://[$server_addr]/opennet/linux';
    # sub_filter 'https://linux.opennet.ru' 'http://[$server_addr]/opennet/linux';

    # sub_filter 'http://linux.opennet.me' 'http://[$server_addr]/opennet/linux';
    # sub_filter 'https://linux.opennet.me' 'http://[$server_addr]/opennet/linux';

    # web
    # sub_filter 'http://web.opennet.ru' 'http://[$server_addr]/opennet/web';
    # sub_filter 'https://web.opennet.ru' 'http://[$server_addr]/opennet/web';

    # sub_filter 'http://web.opennet.me' 'http://[$server_addr]/opennet/web';
    # sub_filter 'https://web.opennet.me' 'http://[$server_addr]/opennet/web';

    # security
    # sub_filter 'http://security.opennet.ru' 'http://[$server_addr]/opennet/security';
    # sub_filter 'https://security.opennet.ru' 'http://[$server_addr]/opennet/security';

    # sub_filter 'http://security.opennet.me' 'http://[$server_addr]/opennet/security';
    # sub_filter 'https://security.opennet.me' 'http://[$server_addr]/opennet/security';

    # palm
    # sub_filter 'http://palm.opennet.ru' 'http://[$server_addr]/opennet/palm';
    # sub_filter 'https://palm.opennet.ru' 'http://[$server_addr]/opennet/palm';

    # sub_filter 'http://palm.opennet.me' 'http://[$server_addr]/opennet/palm';
    # sub_filter 'https://palm.opennet.me' 'http://[$server_addr]/opennet/palm';

    # grab
    # sub_filter 'http://grab.opennet.ru' 'http://[$server_addr]/opennet/grab';
    # sub_filter 'https://grab.opennet.ru' 'http://[$server_addr]/opennet/grab';

    # sub_filter 'http://grab.opennet.me' 'http://[$server_addr]/opennet/grab';
    # sub_filter 'https://grab.opennet.me' 'http://[$server_addr]/opennet/grab';

    # Disable JS / trackers by default
    sub_filter '<script' '<!-- <script';
    sub_filter '</script>' '</script> -->';

    # Relative paths
    sub_filter 'href="/' 'href="http://[$server_addr]/opennet/';
    sub_filter 'src="/' 'src="http://[$server_addr]/opennet/';
    sub_filter 'data-src="/' 'src="http://[$server_addr]/opennet/';
    sub_filter "url('/" "url('http://[$server_addr]/opennet/";

    # Replace all matches
    sub_filter_once off;

    # Enable multimedia replacement
    sub_filter_types *;
  }
}